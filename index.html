<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>仁教練 游泳課程預約</title>
    <!-- 使用 Google Fonts 導入 Inter 字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自定義 CSS 變數 */
        :root {
            --primary-color: #007BFF;
            --secondary-color: #28a745;
            --accent-color: #007BFF;
            --background-color: #f4f7f6;
            --card-background: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --leave-color: #ffc107;
        }

        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* 自定義日曆樣式以匹配 Tailwind */
        .day {
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: #f3f4f6; /* Tailwind gray-100 */
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 4rem; /* 確保格子高度一致 */
            font-weight: 600;
        }

        .day:hover {
            background-color: #e5e7eb; /* Tailwind gray-200 */
            transform: translateY(-2px);
        }

        .day.empty-day {
            background-color: transparent;
            cursor: default;
        }

        .day.unavailable {
            background-color: #e9ecef;
            color: #adb5bd;
            cursor: not-allowed;
        }
        
        .day.coach-leave {
            background-color: var(--leave-color);
            color: white;
            box-shadow: 0 2px 4px rgba(255, 193, 7, 0.4);
        }
        
        .day.coach-leave:hover {
            background-color: #e0a800;
        }

        .day.has-slots {
            background-color: var(--secondary-color);
            color: white;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
        }
        
        .day.has-slots:hover {
            background-color: #218838; /* Slightly darker green on hover */
        }

        .day.today {
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3);
        }
        
        /* 修正後的時段樣式，直接使用標準 CSS */
        .time-slot {
            background-color: #f3f4f6; /* Tailwind 的 gray-100 */
            color: #374151; /* Tailwind 的 gray-800 */
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e5e7eb; /* Tailwind 的 gray-200 */
        }
        .time-slot:hover:not(.full) {
            background-color: #e5e7eb; /* Tailwind 的 gray-200 */
        }
        .time-slot.selected {
            background-color: #2563eb; /* Tailwind 的 blue-600 */
            color: white;
            border-color: #2563eb;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.5); /* 強調選取狀態 */
            transform: scale(1.05);
        }
        .time-slot.full {
            background-color: #d1d5db; /* Tailwind 的 gray-300 */
            color: #6b7280; /* Tailwind 的 gray-500 */
            cursor: not-allowed;
            text-decoration: line-through;
        }

        /* 彈窗淡入動畫 */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-background {
            background-color: rgba(0, 0, 0, 0.4);
        }
        
        .modal-content {
            animation: fadeIn 0.3s ease-out;
        }

        /* 讓確認按鈕也有明顯的啟用/停用狀態 */
        button:disabled {
            background-color: #cbd5e1; /* Tailwind 的 gray-300 */
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body class="bg-blue-50">

    <header class="bg-white shadow-lg py-8">
        <div class="max-w-4xl mx-auto px-4 text-center">
            <h1 class="text-4xl font-extrabold text-blue-600">仁教練 游泳課程預約</h1>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 md:p-8 space-y-8">
        <!-- 教練資訊區塊 -->
        <section class="bg-white p-6 md:p-10 rounded-2xl shadow-xl flex flex-col md:flex-row items-center gap-8">
            <!-- 註解：請在這裡替換你的教練照片。 -->
            <img src="coach.png" alt="教練大頭貼" class="w-40 h-40 rounded-full object-cover border-4 border-green-500 shadow-md">
            <div class="text-center md:text-left">
                <h2 class="text-3xl font-bold text-blue-600 mb-2">仁教練</h2>
                <p class="text-gray-600 text-lg">
                    你好！我是仁教練，擁有十年游泳教學經驗，擅長兒童、成人游泳基礎教學及各項泳姿調整。期待在泳池與你相見！
                </p>
            </div>
        </section>

        <!-- 日曆與預約區塊 -->
        <section class="bg-white p-6 md:p-10 rounded-2xl shadow-xl">
            <div id="firebase-error-message" class="bg-red-100 text-red-700 border border-red-300 p-4 rounded-lg mb-4 text-center hidden">
                <p class="font-bold">錯誤：無法連接到 Firebase。</p>
                <p>請檢查您的 Firebase 專案設定，並確保已啟用匿名登入。</p>
            </div>
            
            <div class="flex justify-between items-center mb-6">
                <button id="prev-month" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">&lt;</button>
                <h2 id="current-month-year" class="text-2xl font-bold text-gray-800"></h2>
                <button id="next-month" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">&gt;</button>
            </div>
            
            <div class="flex justify-center items-center mb-6 gap-4">
                <label for="year-select" class="text-gray-600">選擇年份:</label>
                <select id="year-select" class="p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
            </div>

            <div id="calendar-grid-container">
                <div class="calendar-grid grid grid-cols-7 gap-2 text-center">
                    <!-- 星期幾的標頭會由 JavaScript 動態生成，以確保排版正確 -->
                </div>
            </div>
        </section>
        
        <!-- 管理員功能區塊 -->
        <section id="admin-section" class="bg-white p-6 md:p-10 rounded-2xl shadow-xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">管理員功能</h2>
            <div id="admin-login-form">
                <p class="text-gray-600 mb-4">請輸入您的教練姓名和電話來進行管理員身分驗證。</p>
                <div class="space-y-4">
                    <div class="flex flex-col">
                        <label for="admin-name" class="text-gray-700 mb-1">姓名：</label>
                        <input type="text" id="admin-name" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex flex-col">
                        <label for="admin-phone" class="text-gray-700 mb-1">電話：</label>
                        <input type="tel" id="admin-phone" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <button id="admin-login-btn" class="mt-6 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg transition-colors">管理員登入</button>
            </div>
            
            <div id="admin-options" class="admin-options mt-6 space-y-4 hidden">
                <button id="search-booking-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg transition-colors">查詢所有預約及刪除</button>
                <button id="toggle-leave-mode-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg transition-colors">切換請假模式</button>
            </div>
            
            <div id="search-results" class="mt-6 space-y-3">
                <!-- 查詢結果會顯示在這裡 -->
            </div>
        </section>
        
        <!-- 使用者資訊輸入彈窗 -->
        <div id="user-info-modal" class="modal fixed inset-0 flex items-center justify-center p-4 modal-background z-50 hidden">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md relative modal-content">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">請輸入您的聯絡資訊</h3>
                <div class="space-y-4">
                    <div class="flex flex-col">
                        <label for="user-name" class="text-gray-700 mb-1">姓名：</label>
                        <input type="text" id="user-name" required class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div class="flex flex-col">
                        <label for="user-phone" class="text-gray-700 mb-1">電話：</label>
                        <input type="tel" id="user-phone" required class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                </div>
                <button id="submit-user-info" class="mt-6 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition-colors">確認</button>
            </div>
        </div>

        <!-- 預約時段選擇彈窗 -->
        <div id="booking-modal" class="modal fixed inset-0 flex items-center justify-center p-4 modal-background z-50 hidden">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md relative modal-content">
                <span id="close-booking-modal" class="close-button absolute top-4 right-6 text-gray-400 hover:text-gray-800 text-3xl font-bold transition-colors cursor-pointer">&times;</span>
                <h3 class="text-2xl font-bold text-gray-800 mb-4">預約 <span id="modal-date" class="text-blue-500"></span> 的課程</h3>
                <div id="time-slots" class="grid grid-cols-2 gap-3 mt-6">
                </div>
                <button id="confirm-booking" class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition-colors" disabled>確認預約</button>
            </div>
        </div>

        <!-- 教練預約排程彈窗 -->
        <div id="admin-schedule-modal" class="modal fixed inset-0 flex items-center justify-center p-4 modal-background z-50 hidden">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-lg relative modal-content">
                <span id="close-admin-schedule-modal" class="close-button absolute top-4 right-6 text-gray-400 hover:text-gray-800 text-3xl font-bold transition-colors cursor-pointer">&times;</span>
                <h3 class="text-2xl font-bold text-gray-800 mb-4">教練排程：<span id="admin-modal-date" class="text-blue-500"></span></h3>
                <div id="admin-schedule-list" class="mt-6 space-y-4 max-h-96 overflow-y-auto">
                    <!-- 排程內容會動態生成在這裡 -->
                </div>
            </div>
        </div>

        <!-- 自訂訊息彈窗 (新增) -->
        <div id="message-modal" class="modal fixed inset-0 flex items-center justify-center p-4 modal-background z-50 hidden">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm relative modal-content">
                <div id="message-modal-header" class="px-6 py-4 rounded-t-2xl text-white flex justify-between items-center">
                    <h3 id="message-modal-title" class="text-xl font-bold"></h3>
                    <span id="close-message-modal" class="text-3xl font-bold transition-colors cursor-pointer">&times;</span>
                </div>
                <div class="p-6">
                    <p id="message-modal-body" class="text-gray-700 text-center text-lg mb-6"></p>
                    <div id="message-modal-buttons" class="flex justify-center gap-4">
                        <button id="message-modal-close-btn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">關閉</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 腳本邏輯都已內嵌在這裡 -->
    <script type="module">
        // ----------------------------------------------------------------
        // Firebase 設定
        // ----------------------------------------------------------------
        // 使用 Firebase v9 模組化語法，確保語法一致性
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, addDoc, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDrevpcWddVfJRqRcyxqMR70af_GAIXlFQ",
            authDomain: "coach-reservation.firebaseapp.com",
            projectId: "coach-reservation",
            storageBucket: "coach-reservation.firebasestorage.app",
            messagingSenderId: "580815027044",
            appId: "1:580815027044:web:3fc66b1fd0d797d7f31871"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // ----------------------------------------------------------------
        // 網頁邏輯
        // ----------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            const calendarGrid = document.querySelector('.calendar-grid');
            const currentMonthYear = document.getElementById('current-month-year');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const yearSelect = document.getElementById('year-select');
            
            const userInfoModal = document.getElementById('user-info-modal');
            const userNameInput = document.getElementById('user-name');
            const userPhoneInput = document.getElementById('user-phone');
            const submitUserInfoBtn = document.getElementById('submit-user-info');
            
            const bookingModal = document.getElementById('booking-modal');
            const closeBookingModalBtn = document.getElementById('close-booking-modal');
            const modalDate = document.getElementById('modal-date');
            const timeSlotsContainer = document.getElementById('time-slots');
            const confirmBookingBtn = document.getElementById('confirm-booking');
            
            const firebaseErrorDiv = document.getElementById('firebase-error-message');
            
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const adminNameInput = document.getElementById('admin-name');
            const adminPhoneInput = document.getElementById('admin-phone');
            const adminLoginForm = document.getElementById('admin-login-form');
            const adminOptionsDiv = document.getElementById('admin-options');
            
            const searchBookingBtn = document.getElementById('search-booking-btn');
            const toggleLeaveModeBtn = document.getElementById('toggle-leave-mode-btn');
            const searchResultsDiv = document.getElementById('search-results');

            const adminScheduleModal = document.getElementById('admin-schedule-modal');
            const closeAdminScheduleModalBtn = document.getElementById('close-admin-schedule-modal');
            const adminModalDate = document.getElementById('admin-modal-date');
            const adminScheduleList = document.getElementById('admin-schedule-list');

            // 新增：自訂訊息彈窗相關元素
            const messageModal = document.getElementById('message-modal');
            const messageModalHeader = document.getElementById('message-modal-header');
            const messageModalTitle = document.getElementById('message-modal-title');
            const messageModalBody = document.getElementById('message-modal-body');
            const messageModalButtons = document.getElementById('message-modal-buttons');
            const closeMessageModalBtn = document.getElementById('close-message-modal');

            let currentMonth = new Date().getMonth();
            let currentYear = new Date().getFullYear();
            let selectedDate = null;
            let selectedTime = null;
            
            const MAX_CAPACITY = 4;
            const ALL_TIME_SLOTS = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00'];
            
            const COACH_NAME = '仁';
            const COACH_PHONE = '0970610005';
            
            let userName = '';
            let userPhone = '';
            
            let isAdmin = false;
            let isLeaveMode = false;

            // 新增：顯示自訂訊息彈窗的函數
            function showMessageModal(title, message, isSuccess = true, onConfirm = null) {
                // 重設樣式和內容
                messageModalHeader.className = '';
                messageModalHeader.classList.add('px-6', 'py-4', 'rounded-t-2xl', 'text-white', 'flex', 'justify-between', 'items-center');
                messageModalTitle.textContent = title;
                messageModalBody.textContent = message;
                messageModalButtons.innerHTML = ''; // 清空按鈕

                if (isSuccess) {
                    messageModalHeader.classList.add('bg-green-500');
                    closeMessageModalBtn.classList.add('hover:text-green-200');
                } else {
                    messageModalHeader.classList.add('bg-red-500');
                    closeMessageModalBtn.classList.add('hover:text-red-200');
                }

                if (onConfirm) {
                    // 帶有確認功能的彈窗
                    const confirmBtn = document.createElement('button');
                    confirmBtn.classList.add('flex-1', 'bg-red-500', 'hover:bg-red-600', 'text-white', 'font-bold', 'py-3', 'px-6', 'rounded-lg', 'transition-colors');
                    confirmBtn.textContent = '確定';
                    confirmBtn.addEventListener('click', () => {
                        onConfirm();
                        hideMessageModal();
                    });

                    const cancelBtn = document.createElement('button');
                    cancelBtn.classList.add('flex-1', 'bg-gray-500', 'hover:bg-gray-600', 'text-white', 'font-bold', 'py-3', 'px-6', 'rounded-lg', 'transition-colors');
                    cancelBtn.textContent = '取消';
                    cancelBtn.addEventListener('click', () => hideMessageModal());
                    
                    messageModalButtons.appendChild(cancelBtn);
                    messageModalButtons.appendChild(confirmBtn);

                } else {
                    // 一般訊息彈窗
                    const closeBtn = document.createElement('button');
                    closeBtn.classList.add('flex-1', 'bg-gray-500', 'hover:bg-gray-600', 'text-white', 'font-bold', 'py-3', 'px-6', 'rounded-lg', 'transition-colors');
                    closeBtn.textContent = '關閉';
                    closeBtn.addEventListener('click', () => hideMessageModal());
                    messageModalButtons.appendChild(closeBtn);
                }

                messageModal.classList.remove('hidden');
                messageModal.classList.add('flex');
            }

            // 新增：隱藏自訂訊息彈窗的函數
            function hideMessageModal() {
                messageModal.classList.remove('flex');
                messageModal.classList.add('hidden');
            }

            // 關閉自訂訊息彈窗按鈕
            closeMessageModalBtn.addEventListener('click', () => hideMessageModal());
            
            // 點擊背景關閉彈窗
            window.onclick = (event) => {
                if (event.target === bookingModal) {
                    bookingModal.classList.remove('flex');
                    bookingModal.classList.add('hidden');
                }
                if (event.target === adminScheduleModal) {
                    adminScheduleModal.classList.remove('flex');
                    adminScheduleModal.classList.add('hidden');
                }
                if (event.target === userInfoModal) {
                    // 點擊背景不關閉使用者資訊彈窗
                }
                if (event.target === messageModal) {
                    hideMessageModal();
                }
            };

            signInAnonymously(auth).then(() => {
                console.log("匿名登入成功！");
                if (!userName || !userPhone) {
                    userInfoModal.classList.remove('hidden');
                    userInfoModal.classList.add('flex');
                }
                renderCalendar();
            }).catch((error) => {
                console.error("匿名登入失敗:", error);
                firebaseErrorDiv.style.display = 'block';
            });

            submitUserInfoBtn.addEventListener('click', () => {
                const name = userNameInput.value.trim();
                const phone = userPhoneInput.value.trim();
                
                if (name && phone) {
                    userName = name;
                    userPhone = phone;
                    userInfoModal.classList.remove('flex');
                    userInfoModal.classList.add('hidden');
                } else {
                    showMessageModal('錯誤', '請完整填寫姓名和電話。', false);
                }
            });

            function initYearSelect() {
                const currentYear = new Date().getFullYear();
                yearSelect.innerHTML = '';
                for (let i = currentYear; i <= 2050; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    if (i === currentYear) {
                        option.selected = true;
                    }
                    yearSelect.appendChild(option);
                }
            }

            async function renderCalendar() {
                calendarGrid.innerHTML = '';
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                weekdays.forEach(dayText => {
                    const header = document.createElement('div');
                    header.classList.add('weekday', 'font-bold', 'text-blue-600', 'py-2');
                    header.textContent = dayText;
                    calendarGrid.appendChild(header);
                });

                const date = new Date(currentYear, currentMonth, 1);
                const firstDayOfMonth = date.getDay();
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                
                currentMonthYear.textContent = `${currentYear} 年 ${currentMonth + 1} 月`;
                yearSelect.value = currentYear;

                const formattedMonth = String(currentMonth + 1).padStart(2, '0');
                
                try {
                    const schedulesCollection = collection(db, 'schedules');
                    const q = query(
                        schedulesCollection,
                        where('date', '>=', `${currentYear}-${formattedMonth}-01`),
                        where('date', '<=', `${currentYear}-${formattedMonth}-${daysInMonth}`)
                    );
                    const querySnapshot = await getDocs(q);
                    
                    const bookedSlotCounts = {};
                    querySnapshot.forEach(doc => {
                        const slot = doc.data();
                        const slotKey = `${slot.date}-${slot.time}`;
                        bookedSlotCounts[slotKey] = (bookedSlotCounts[slotKey] || 0) + 1;
                    });
                    
                    const coachLeaveCollection = collection(db, 'coachLeave');
                    const leaveSnapshot = await getDocs(coachLeaveCollection);
                    const leaveDates = new Set();
                    leaveSnapshot.forEach(doc => {
                        leaveDates.add(doc.id);
                    });
                    
                    for (let i = 0; i < firstDayOfMonth; i++) {
                        const emptyDay = document.createElement('div');
                        emptyDay.classList.add('day', 'empty-day');
                        calendarGrid.appendChild(emptyDay);
                    }

                    for (let i = 1; i <= daysInMonth; i++) {
                        const day = document.createElement('div');
                        day.textContent = i;
                        day.classList.add('day');
                        
                        const today = new Date();
                        const formattedDate = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                        const currentDayDate = new Date(formattedDate);
                        
                        const isLeaveDay = leaveDates.has(formattedDate);
                        const isPastDay = currentDayDate < today.setHours(0,0,0,0);
                        const isToday = i === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear();
                        
                        const hasAvailableSlot = ALL_TIME_SLOTS.some(time => {
                            const slotKey = `${formattedDate}-${time}`;
                            return (bookedSlotCounts[slotKey] || 0) < MAX_CAPACITY;
                        });

                        if (isAdmin && isLeaveMode) {
                            if (isLeaveDay) {
                                day.classList.add('coach-leave');
                                day.addEventListener('click', () => toggleLeave(formattedDate, false));
                            } else {
                                day.addEventListener('click', () => toggleLeave(formattedDate, true));
                            }
                        } else if (isAdmin) {
                            if (isPastDay) {
                                day.classList.add('unavailable');
                            } else {
                                day.classList.add('has-slots');
                                day.addEventListener('click', () => showAdminScheduleModal(formattedDate));
                            }
                        } else {
                            if (isPastDay || isLeaveDay) {
                                day.classList.add('unavailable');
                                if (isLeaveDay) {
                                    day.classList.add('coach-leave');
                                }
                            } else if (hasAvailableSlot) {
                                day.classList.add('has-slots');
                                day.addEventListener('click', () => {
                                    if (!userName || !userPhone) {
                                        userInfoModal.classList.remove('hidden');
                                        userInfoModal.classList.add('flex');
                                    } else {
                                        showBookingModal(formattedDate, bookedSlotCounts);
                                    }
                                });
                            } else {
                                day.classList.add('unavailable');
                            }
                        }
                        
                        if (isToday) {
                            day.classList.add('today');
                        }
                        
                        calendarGrid.appendChild(day);
                    }
                } catch (error) {
                    console.error("渲染日曆失敗:", error);
                    showMessageModal('錯誤', '載入預約資訊失敗，請檢查網路連線或稍後再試。', false);
                }
            }
            
            timeSlotsContainer.addEventListener('click', (event) => {
                const clickedSlot = event.target.closest('.time-slot');
                if (clickedSlot && !clickedSlot.classList.contains('full')) {
                    document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                    clickedSlot.classList.add('selected');
                    selectedTime = clickedSlot.getAttribute('data-time');
                    confirmBookingBtn.disabled = false;
                }
            });

            function showBookingModal(date, bookedSlotCounts) {
                bookingModal.classList.remove('hidden');
                bookingModal.classList.add('flex');
                modalDate.textContent = date;
                timeSlotsContainer.innerHTML = '';
                confirmBookingBtn.disabled = true;
                selectedDate = date;
                selectedTime = null;

                ALL_TIME_SLOTS.forEach(slotTime => {
                    const slotKey = `${date}-${slotTime}`;
                    const currentBookings = bookedSlotCounts[slotKey] || 0;
                    const isFull = currentBookings >= MAX_CAPACITY;
                    
                    const timeSlot = document.createElement('div');
                    timeSlot.classList.add('time-slot');
                    timeSlot.setAttribute('data-time', slotTime);
                    timeSlot.textContent = `${slotTime} (${currentBookings}/${MAX_CAPACITY})`;
                    
                    if (isFull) {
                        timeSlot.classList.add('full');
                    }
                    timeSlotsContainer.appendChild(timeSlot);
                });
            }
            
            confirmBookingBtn.addEventListener('click', async () => {
                if (selectedTime && userName && userPhone) {
                    const schedulesCollection = collection(db, 'schedules');
                    const q = query(
                        schedulesCollection,
                        where('date', '==', selectedDate),
                        where('time', '==', selectedTime)
                    );
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.size >= MAX_CAPACITY) {
                        showMessageModal('錯誤', '抱歉，此時段已被預約額滿，請選擇其他時段。', false);
                        bookingModal.classList.remove('flex');
                        bookingModal.classList.add('hidden');
                        renderCalendar();
                        return;
                    }

                    try {
                        await addDoc(schedulesCollection, {
                            date: selectedDate,
                            time: selectedTime,
                            userName: userName,
                            userPhone: userPhone
                        });
                        
                        showMessageModal('預約成功', `恭喜您，${userName}！已成功預約 ${selectedDate} ${selectedTime} 的課程。`, true);
                        bookingModal.classList.remove('flex');
                        bookingModal.classList.add('hidden');
                        renderCalendar();
                    } catch (error) {
                        console.error("預約失敗:", error);
                        showMessageModal('錯誤', '預約失敗，請稍後再試。', false);
                    }
                } else {
                    showMessageModal('錯誤', '請先填寫您的姓名和電話，或選擇一個時段。', false);
                    bookingModal.classList.remove('flex');
                    bookingModal.classList.add('hidden');
                    userInfoModal.classList.remove('hidden');
                    userInfoModal.classList.add('flex');
                }
            });

            prevMonthBtn.addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar();
            });

            nextMonthBtn.addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar();
            });

            yearSelect.addEventListener('change', (e) => {
                currentYear = parseInt(e.target.value);
                renderCalendar();
            });
            
            closeBookingModalBtn.addEventListener('click', () => {
                bookingModal.classList.remove('flex');
                bookingModal.classList.add('hidden');
            });

            closeAdminScheduleModalBtn.addEventListener('click', () => {
                adminScheduleModal.classList.remove('flex');
                adminScheduleModal.classList.add('hidden');
            });
            
            // ----------------------------------------------------------------
            // 管理員功能邏輯 (已修改)
            // ----------------------------------------------------------------
            adminLoginBtn.addEventListener('click', () => {
                const name = adminNameInput.value.trim();
                const phone = adminPhoneInput.value.trim();

                if (name === COACH_NAME && phone === COACH_PHONE) {
                    showMessageModal('登入成功', '教練登入成功！', true);
                    isAdmin = true;
                    adminLoginForm.classList.add('hidden');
                    adminOptionsDiv.classList.remove('hidden');
                    searchResultsDiv.innerHTML = '';
                    renderCalendar();
                } else {
                    showMessageModal('登入失敗', '教練姓名或電話不正確。', false);
                    isAdmin = false;
                }
            });
            
            searchBookingBtn.addEventListener('click', searchBookings);
            
            async function searchBookings() {
                if (!isAdmin) {
                    showMessageModal('權限不足', '請先以教練身份登入。', false);
                    return;
                }
                
                isLeaveMode = false;
                toggleLeaveModeBtn.textContent = '切換請假模式';
                searchResultsDiv.innerHTML = '<p class="text-gray-500 text-center">正在查詢所有預約中...</p>';
                
                try {
                    const schedulesCollection = collection(db, 'schedules');
                    const querySnapshot = await getDocs(schedulesCollection);
                    
                    const results = [];
                    querySnapshot.forEach(doc => {
                        const booking = doc.data();
                        results.push({ id: doc.id, ...booking });
                    });
                    
                    results.sort((a, b) => {
                        if (a.date === b.date) {
                            return a.time.localeCompare(b.time);
                        }
                        return a.date.localeCompare(b.date);
                    });
                    
                    displaySearchResults(results);
                } catch (error) {
                    console.error("查詢所有預約失敗:", error);
                    searchResultsDiv.innerHTML = '<p class="text-red-500 text-center">查詢預約時發生錯誤，請稍後再試。</p>';
                }
            }

            function displaySearchResults(results) {
                searchResultsDiv.innerHTML = '';
                if (results.length === 0) {
                    searchResultsDiv.innerHTML = '<p class="text-gray-500 text-center">目前沒有任何預約記錄。</p>';
                    return;
                }
                
                results.forEach(booking => {
                    const resultDiv = document.createElement('div');
                    resultDiv.classList.add('flex', 'items-center', 'justify-between', 'bg-gray-100', 'p-4', 'rounded-lg', 'shadow-sm');
                    resultDiv.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${booking.date} ${booking.time}</p>
                            <p class="text-sm text-gray-600">預約人：${booking.userName} (${booking.userPhone})</p>
                        </div>
                        <button class="delete-button bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm" data-id="${booking.id}">刪除</button>
                    `;
                    searchResultsDiv.appendChild(resultDiv);
                });
                
                document.querySelectorAll('.delete-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const docId = e.target.getAttribute('data-id');
                        showMessageModal(
                            '確認刪除', 
                            '確定要刪除這筆預約嗎？此操作無法復原！', 
                            false, 
                            () => deleteBooking(docId)
                        );
                    });
                });
            }
            
            async function deleteBooking(docId) {
                try {
                    const bookingDocRef = doc(db, 'schedules', docId);
                    await deleteDoc(bookingDocRef);
                    showMessageModal('刪除成功', '預約已成功刪除！', true);
                    searchBookings();
                    renderCalendar();
                } catch (error) {
                    console.error("刪除預約失敗:", error);
                    showMessageModal('刪除失敗', '刪除預約失敗，請稍後再試。', false);
                }
            }
            
            // ----------------------------------------------------------------
            // 新增功能：教練請假模式
            // ----------------------------------------------------------------
            toggleLeaveModeBtn.addEventListener('click', () => {
                if (!isAdmin) {
                    showMessageModal('權限不足', '請先以教練身份登入。', false);
                    return;
                }
                isLeaveMode = !isLeaveMode;
                toggleLeaveModeBtn.textContent = isLeaveMode ? '離開請假模式' : '切換請假模式';
                searchResultsDiv.innerHTML = isLeaveMode ? '<p class="text-gray-500 text-center">請點擊日曆上的日期來標記或取消請假。</p>' : '';
                renderCalendar();
            });
            
            async function toggleLeave(date, isLeaving) {
                const coachLeaveCollection = collection(db, 'coachLeave');
                const docRef = doc(coachLeaveCollection, date);
                
                try {
                    if (isLeaving) {
                        const schedulesCollection = collection(db, 'schedules');
                        const q = query(schedulesCollection, where('date', '==', date));
                        const snapshot = await getDocs(q);
                        if (!snapshot.empty) {
                            showMessageModal('錯誤', '該日已有預約，無法請假。請先刪除所有預約後再嘗試。', false);
                            return;
                        }
                        await setDoc(docRef, { date: date });
                        showMessageModal('請假成功', `${date} 已被標記為請假日。`, true);
                    } else {
                        await deleteDoc(docRef);
                        showMessageModal('請假取消', `${date} 的請假已取消。`, true);
                    }
                    renderCalendar();
                } catch (error) {
                    console.error("切換請假狀態失敗:", error);
                    showMessageModal('錯誤', '操作失敗，請稍後再試。', false);
                }
            }

            // ----------------------------------------------------------------
            // 新增功能：教練模式下的預約排程查看
            // ----------------------------------------------------------------
            async function showAdminScheduleModal(date) {
                adminScheduleModal.classList.remove('hidden');
                adminScheduleModal.classList.add('flex');
                adminModalDate.textContent = date;
                adminScheduleList.innerHTML = '<p class="text-center text-gray-500">正在載入排程...</p>';

                try {
                    const schedulesCollection = collection(db, 'schedules');
                    const q = query(schedulesCollection, where('date', '==', date));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        adminScheduleList.innerHTML = '<p class="text-center text-gray-500">本日目前沒有任何預約。</p>';
                        return;
                    }

                    adminScheduleList.innerHTML = '';
                    const bookings = [];
                    querySnapshot.forEach(doc => {
                        bookings.push({ id: doc.id, ...doc.data() });
                    });

                    bookings.sort((a, b) => a.time.localeCompare(b.time));

                    bookings.forEach(booking => {
                        const bookingItem = document.createElement('div');
                        bookingItem.classList.add('flex', 'items-center', 'justify-between', 'bg-gray-100', 'p-4', 'rounded-lg', 'shadow-sm');
                        bookingItem.innerHTML = `
                            <div>
                                <p class="font-semibold text-gray-800">${booking.time}</p>
                                <p class="text-sm text-gray-600">預約人：${booking.userName} (${booking.userPhone})</p>
                            </div>
                            <button class="delete-booking-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm" data-id="${booking.id}">刪除</button>
                        `;
                        adminScheduleList.appendChild(bookingItem);
                    });

                    document.querySelectorAll('.delete-booking-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const docId = e.target.getAttribute('data-id');
                            showMessageModal(
                                '確認刪除', 
                                '確定要刪除這筆預約嗎？此操作無法復原！', 
                                false, 
                                () => deleteBookingFromAdminView(docId, date)
                            );
                        });
                    });

                } catch (error) {
                    console.error("載入教練排程失敗:", error);
                    adminScheduleList.innerHTML = '<p class="text-red-500 text-center">載入排程時發生錯誤。</p>';
                }
            }

            async function deleteBookingFromAdminView(docId, date) {
                try {
                    const bookingDocRef = doc(db, 'schedules', docId);
                    await deleteDoc(bookingDocRef);
                    showMessageModal('刪除成功', '預約已成功刪除！', true);
                    showAdminScheduleModal(date);
                    renderCalendar();
                } catch (error) {
                    console.error("刪除預約失敗:", error);
                    showMessageModal('刪除失敗', '刪除預約失敗，請稍後再試。', false);
                }
            }
            
            initYearSelect();
        });
    </script>
</body>
</html>
